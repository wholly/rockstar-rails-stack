# $Id: Portfile 44945 2009-01-05 00:03:26Z ryandesign@macports.org $

PortSystem      1.0

name            dbus-legacy
version         1.2.4
revision        0
maintainers     illogic-al
categories      devel
platforms       darwin
description     A message bus system, a simple way for applications to talk to one another.
long_description \
    ${description} This is the older 1.2.4 version which has been patched \
    to work with launchd. 
distname        dbus-${version}

homepage        http://www.freedesktop.org/Software/dbus
master_sites    http://dbus.freedesktop.org/releases/dbus

checksums       md5     2e643910a09f44b000a0d76038637999 \
                sha1    913d796b79802b6ee6ca2b0ef59c670f3fd79774 \
                rmd160  0441eb8b668ed70250e484b02fe6a83c05c9a088

depends_build 	port:pkgconfig \
		port:libtool \
		port:automake

depends_lib     port:expat

patchfiles	dbus-launchd-modified.patch
patch.pre_args	-p1

configure.args  --mandir=${prefix}/share/man \
                --disable-tests \
                --disable-doxygen-docs \
                --disable-xml-docs \
                --enable-kqueue \
                --enable-launchd \
                --without-x \
                --with-dbus-daemondir=${prefix}/bin
    
configure.cflags-append -no-cpp-precomp
#configure.cflags-append -flat_namespace

use_parallel_build  yes

test.run        yes
test.target     check

# We need to regenerate configure from a patched configure.in
pre-configure {
    system "cd ${worksrcpath} && autoreconf"
}

post-configure {
    copy -force ${prefix}/bin/glibtool ${worksrcpath}/libtool
}

pre-test {
    if {![variant_isset test]} {
        ui_error "test variant must be activated to enable test support."
        error "Please enable test variant."
    }
}

post-destroot {
    file mkdir ${destroot}${prefix}/share/dbus-1/services
    file mkdir ${destroot}${prefix}/var/run/dbus
    file mkdir ${destroot}${prefix}/var/lib/dbus
    file mkdir ${destroot}${prefix}/etc/dbus-1/system.d
    file mkdir ${destroot}${prefix}/etc/dbus-1/session.d
}

destroot.keepdirs \
    ${destroot}${prefix}/share/dbus-1/services \
    ${destroot}${prefix}/var/run/dbus \
    ${destroot}${prefix}/var/lib/dbus \
    ${destroot}${prefix}/etc/dbus-1/system.d \
    ${destroot}${prefix}/etc/dbus-1/session.d

startupitem.create  yes
startupitem.name    dbus
startupitem.init    XDG_DATA_DIRS=${prefix}/share
startupitem.start   "${prefix}/bin/dbus-daemon --system"
startupitem.stop    "kill `cat ${prefix}/var/run/dbus/pid`"
startupitem.restart "kill `cat ${prefix}/var/run/dbus/pid` ; ${prefix}/bin/dbus-daemon --system"

pre-activate {
    addgroup messagebus
    adduser messagebus gid=[existsgroup messagebus] realname=Message\ Bus
}

post-activate {
    file attributes ${prefix}/var/run/dbus -group messagebus -owner messagebus
    file attributes ${prefix}/libexec/dbus-daemon-launch-helper -group messagebus
    system "${prefix}/bin/dbus-uuidgen --ensure"
}

variant test {
    configure.args-delete   --disable-tests
    configure.args-append   --enable-tests
}

platform darwin 7 {
    configure.args-delete   --enable-kqueue
}

livecheck.check regex
livecheck.regex {D-Bus (\d+(?:\.\d+)*)}
