# -*- mode: tcl; tab-width: 4; indent-tabs-mode: nil; c-basic-offset: 4 -*-
# $Id: Portfile 40666 2008-10-10 05:03:18Z sfiera@macports.org $

PortSystem 1.0

name            cgit
version         0.8
set git-version 1.6.0.2
categories      www devel
maintainers     sfiera openmaintainer
description     A fast web interface for the git source code management system
homepage        http://hjemli.net/git/cgit/
platforms       darwin

long_description \
    cgit is an attempt to create a fast web interface for the git scm, using a \
    builtin cache to decrease server io-pressure. It can run on any \
    CGI-capable web server.

use_bzip2       yes
set cgit-dist   ${name}-${version}${extract.suffix}?id=v${version}
set git-dist    git-${git-version}${extract.suffix}
distfiles       ${cgit-dist}:cgit ${git-dist}:git
master_sites    ${homepage}snapshot:cgit \
                http://www.kernel.org/pub/software/scm/git:git
checksums       ${cgit-dist} \
                    md5 f846689c9789a4f1d4adf9a79831a02e \
                    sha1 c4280f37f4fc7804647d6194ab37c213cd55c718 \
                    rmd160 78dd029d2dc3f05e3fd6660a3b62177c85240d58 \
                ${git-dist} \
                    md5 1e4d9bfc1cb0abf165d4de93b5172324 \
                    sha1 4a1d78604d1fb6c0deb43a498feb454970fb6704 \
                    rmd160 eb91ca256d0fbcc956f91ad02da659d9b322261d

depends_lib     port:git-core \
                port:openssl \
                port:zlib \
                port:libiconv

post-extract {
    file delete ${worksrcpath}/git
    file rename ${worksrcpath}/../git-${git-version} ${worksrcpath}/git
}

post-patch {
    file copy ${filespath}/cgit.conf ${worksrcpath}/cgit.conf
    reinplace "s|@PREFIX@|${prefix}|g" ${worksrcpath}/cgit.conf
    reinplace "s|@GIT_VER@|${git-version}|g" ${worksrcpath}/cgit.conf
}

post-destroot {
    xinstall -m 444 ${worksrcpath}/cgitrc ${destroot}${prefix}/etc/cgitrc.sample
    xinstall -m 700 -o www -g www -d ${destroot}${prefix}/var/cache/cgit
    destroot.keepdirs ${destroot}${prefix}/var/cache/cgit
}

worksrcdir      ${name}
use_configure   no
build.env       CFLAGS='-L${prefix}/lib -liconv'

livecheck.check none
