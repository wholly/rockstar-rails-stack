# $Id: Portfile 49965 2009-04-21 11:42:22Z takanori@macports.org $

PortSystem       1.0

name             konversation
version          1.1
set kdeadmin     kde-admindir-1024
categories       kde
maintainers      nomaintainer
description      KDE IRC client.\
                 NB No KDE sound support.
long_description ${description}
platforms        darwin
homepage         http://konversation.kde.org/
master_sites     http://download.berlios.de/${name} \
                 http://ranger.users.finkproject.org/distfiles/kde-admindir/:admin \
                 http://ranger.befunk.com/fink/kde-admindir/:admin \
                 http://astrange.ithinksw.net/~astrange/ranger-fink/kde-admindir/:admin \
                 http://www.southofheaven.net/befunk/kde-admindir/:admin
use_bzip2        yes
distname         ${name}-${version}
distfiles        ${distname}.tar.bz2 ${kdeadmin}.tar.bz2:admin
depends_build    port:autoconf \
                 port:unsermake
depends_lib      port:kdebase3 \
                 port:doxygen \
                 path:bin/dot:graphviz

checksums        ${distname}.tar.bz2 md5 0d38a16747ab4f6549863de385cb551c \
                 ${kdeadmin}.tar.bz2 md5 d99491aa5d520fd1d70393a718019322

extract.only     ${distname}.tar.bz2
post-extract { system "cd ${worksrcpath} && bzcat -dc ${distpath}/${kdeadmin}.tar.bz2 | tar xf -" }

patchfiles
patch       {
        foreach file $patchfiles {
            system "cd ${worksrcpath} && sed -e 's,@FINKPREFIX@,${prefix},g' ${filespath}/${file} | patch -p1"
        }
        system "perl -pi -e 's,-O2,-Os,g; s,doc/HTML,doc/kde,g; s,/usr/share/doc/packages/qt3/html,${prefix}/share/doc/qt3/html,g;' ${worksrcpath}/admin/*"
        system "echo \"KDE_ENABLE_HIDDEN_VISIBILITY\" >> ${worksrcpath}/configure.in.in"
}

post-patch      {
        reinplace "s|/lib/freetype219||g" ${worksrcpath}/environment-helper.sh
        reinplace "s|--with-ssl-dir=/usr|--with-ssl-dir=\$PREFIX|g" ${worksrcpath}/environment-helper.sh
        reinplace "s|HOME=/tmp|HOME=${workpath}|g" ${worksrcpath}/environment-helper.sh
        reinplace "s|/tmp/buildlog|${workpath}/buildlog|g" ${worksrcpath}/build-helper.sh
        foreach file {CompileScript.sh InstallScript.sh} {
            file copy ${filespath}/${file} ${worksrcpath}
            reinplace "s|%p|${prefix}|g" ${worksrcpath}/${file}
            reinplace "s|%N|${name}|g" ${worksrcpath}/${file}
            reinplace "s|%v|${version}|g" ${worksrcpath}/${file}
            reinplace "s|%r|${revision}|g" ${worksrcpath}/${file}
            reinplace "s|%c|${configure.args}|g" ${worksrcpath}/${file}
            reinplace "s|%d|${destroot}|g" ${worksrcpath}/${file}
            reinplace "s|%i|${destroot}${prefix}|g" ${worksrcpath}/${file}
            file attributes ${worksrcpath}/${file} -permissions 0755
        }
}

configure.args  --with-distribution='MacPorts/Mac OS X' --without-arts

use_configure       no
use_parallel_build  yes

build           { system "cd ${worksrcpath} && MAKEFLAGS=\"-j ${build.jobs}\" ./CompileScript.sh" }

destroot    { system "cd ${worksrcpath} && ./InstallScript.sh" }

post-destroot   {
        xinstall -m 755 -d ${destroot}${prefix}/share/doc/${name}
        xinstall -m 644 -W ${worksrcpath} AUTHORS COPYING ChangeLog INSTALL README TODO ${destroot}${prefix}/share/doc/${name}
}
