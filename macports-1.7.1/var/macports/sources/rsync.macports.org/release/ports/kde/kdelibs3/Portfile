# $Id: Portfile 49965 2009-04-21 11:42:22Z takanori@macports.org $

#Synced with Fink, Version 3.5.8-1023

PortSystem 1.0
name		kdelibs3
version		3.5.8
revision	4
set kdeadmin	kde-admindir-1024
categories	kde
maintainers	nomaintainer
description	Essential libraries for KDE applications. \
		NB No KDE sound support.
long_description ${description}
platforms	darwin
homepage	http://www.kde.org/
master_sites	kde:stable/${version}/src/:kde358 \
		http://ranger.users.finkproject.org/distfiles/kde-admindir/:admin \
		http://ranger.befunk.com/fink/kde-admindir/:admin \
		http://astrange.ithinksw.net/~astrange/ranger-fink/kde-admindir/:admin \
		http://www.southofheaven.net/befunk/kde-admindir/:admin
use_bzip2	yes
distname	kdelibs-${version}
distfiles	${distname}.tar.bz2:kde358 \
		${kdeadmin}.tar.bz2:admin
depends_build	port:autoconf \
		port:pkgconfig \
		port:unsermake
depends_lib	lib:libpoll:poll-emulator \
		port:mesa \
		port:aspell \
		port:bzip2 \
		port:expat \
		port:flex \
		port:gettext \
		path:lib/pkgconfig/glib-2.0.pc:glib2 \
		port:hicolor-icon-theme \
		port:jasper \
		port:jpeg \
		port:libart_lgpl \
		port:libidn \
		port:libiconv \
		port:libpng \
		port:libxml2 \
		port:libxslt \
		port:lua \
		port:pcre \
		port:tiff \
		port:openexr \
		port:openssl \
		path:bin/perl:perl5 \
		port:qt3 \
		port:zlib
#		port:dbus
#		port:dbus-qt3
#		port:hal
#depends_run	port:shared-mime-info

checksums	${distname}.tar.bz2 md5 acaa37e79e840d10dca326277a20863c \
		${kdeadmin}.tar.bz2 md5 d99491aa5d520fd1d70393a718019322

extract.only	${distname}.tar.bz2
post-extract	{ system "cd ${worksrcpath} && bzcat -dc ${distpath}/${kdeadmin}.tar.bz2 | tar xf -" }

patchfiles	kdelibs3-unified.patch \
                patch-kdeui_kactionclasses.cpp.diff
patch		{
		foreach file $patchfiles {
		    system "cd ${worksrcpath} && sed -e 's,@FINKPREFIX@,${prefix},g' ${filespath}/${file} | patch -p1"
		}
		system "perl -pi -e 's,-O2,-Os,g; s,doc/HTML,doc/kde,g; s,/usr/share/doc/packages/qt3/html,${prefix}/share/doc/qt3/html,g;' ${worksrcpath}/admin/*"
}
post-patch	{
		reinplace "s|/lib/freetype219||g" ${worksrcpath}/environment-helper.sh
		reinplace "s|--with-ssl-dir=/usr|--with-ssl-dir=\$PREFIX|g" ${worksrcpath}/environment-helper.sh
		reinplace "s|HOME=/tmp|HOME=${workpath}|g" ${worksrcpath}/environment-helper.sh
		reinplace "s|/tmp/buildlog|${workpath}/buildlog|g" ${worksrcpath}/build-helper.sh
		foreach file {CompileScript.sh InstallScript.sh} {
		    file copy ${filespath}/${file} ${worksrcpath}
		    reinplace "s|%p|${prefix}|g" ${worksrcpath}/${file}
		    reinplace "s|%N|${name}|g" ${worksrcpath}/${file}
		    reinplace "s|%v|${version}|g" ${worksrcpath}/${file}
		    reinplace "s|%r|${revision}|g" ${worksrcpath}/${file}
		    reinplace "s|%c|${configure.args}|g" ${worksrcpath}/${file}
		    reinplace "s|%d|${destroot}|g" ${worksrcpath}/${file}
		    reinplace "s|%i|${destroot}${prefix}|g" ${worksrcpath}/${file}
		    file attributes ${worksrcpath}/${file} -permissions 0755
		}
		foreach f {kdeglobals konsolerc} {
			# Monaco CY is not a standard font in Tiger.
			reinplace "s|Monaco CY|Bitstream Vera Sans Mono|g" ${worksrcpath}/darwin/${f}
			reinplace "s|Baghdad|Bitstream Vera Sans|g" ${worksrcpath}/darwin/${f}
		}
		system "echo \"\[FMSettings\]\nStandardFont=Bitstream Vera Sans,10,-1,5,50,0,0,0,0,0\" > ${worksrcpath}/darwin/kdesktoprc"
}

configure.args --enable-cups --with-ldap=framework --with-gssapi=framework --with-distribution='MacPorts/Mac OS X' --without-arts

pre-configure	{
		if {[file exists ${prefix}/bin/cups-config]} {
			return -code error "port:cups-headers may prevent building this port. Please uninstall (or deactivate) cups-headers and restart the build."
		}
}
use_configure       no
use_parallel_build  yes
build           { system "cd ${worksrcpath} && MAKEFLAGS=\"-j ${build.jobs}\" ./CompileScript.sh" }
destroot	{ system "cd ${worksrcpath} && ./InstallScript.sh" }

post-destroot	{
		xinstall -m 755 -d ${destroot}${prefix}/share/doc/${name}
		xinstall -m 644 -W ${worksrcpath} COPYING COPYING.LIB INSTALL ${destroot}${prefix}/share/doc/${name}
}

platform darwin 9 {}

platform darwin 8 {}

platform darwin 7 {}

platform darwin 6 {
		pre-fetch {
			  return -code error "Sorry, your platform is no longer supported."
		}
}

universal_variant	no

variant with_doxygen description {Include API documentation} {
		depends_lib-append port:doxygen
		post-patch { foreach f {CompileScript.sh InstallScript.sh} { reinplace "s|#apidox#||g" ${worksrcpath}/${f} }}
}

variant with_libthai description {Add Thai language support} {
		depends_lib-append	port:libdatrie \
					port:libthai
		configure.args-append	--with-libthai=yes
}

livecheck.check	none
