diff --git sipgen/gencode.c sipgen/gencode.c
index 035c666..41c7e39 100644
--- sipgen/gencode.c
+++ sipgen/gencode.c
@@ -2152,10 +2152,19 @@ static void generateEncodedClass(moduleDef *mod, classDef *cd, int last,
 
     prcode(fp, "{%u, ", cd->classnr);
 
-    if (cmod == mod)
+    if (cmod == mod) {
         prcode(fp, "255");
-    else
-        prcode(fp, "%u", cmod->modulenr);
+    } else {
+        moduleListDef* m = mod->allimports;
+        int i = 0;
+
+        for (; m != NULL; m = m->next, i++) {
+            if (cmod == m->module) {
+                prcode(fp, "%u", i);
+                break;
+            }
+        }
+    }
 
     prcode(fp, ", %u}", last);
 }
